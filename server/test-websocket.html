<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat RTC - Test WebSocket</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #1a1a2e;
            color: #eee;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        h1 {
            color: #6c5ce7;
            margin-bottom: 20px;
        }
        
        .section {
            background: #16213e;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        
        .status.connected {
            background: #00b894;
        }
        
        .status.disconnected {
            background: #d63031;
        }
        
        input, button {
            padding: 10px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
        }
        
        input {
            background: #0f3460;
            color: #eee;
            flex: 1;
            margin-right: 10px;
        }
        
        button {
            background: #6c5ce7;
            color: white;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        button:hover {
            background: #5849c7;
        }
        
        button:disabled {
            background: #555;
            cursor: not-allowed;
        }
        
        .form-group {
            display: flex;
            margin-bottom: 15px;
        }
        
        .messages {
            height: 400px;
            overflow-y: auto;
            background: #0f3460;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        
        .message {
            padding: 8px;
            margin-bottom: 8px;
            border-left: 3px solid #6c5ce7;
            background: rgba(108, 92, 231, 0.1);
        }
        
        .message.system {
            border-left-color: #00b894;
            background: rgba(0, 184, 148, 0.1);
        }
        
        .message .author {
            font-weight: bold;
            color: #6c5ce7;
            margin-right: 5px;
        }
        
        .message .time {
            font-size: 12px;
            color: #888;
            margin-left: 5px;
        }
        
        .typing {
            font-style: italic;
            color: #888;
            padding: 5px;
        }
        
        .users-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .user-tag {
            background: #6c5ce7;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸš€ Chat RTC - Test WebSocket</h1>
        
        <!-- Connexion -->
        <div class="section">
            <h2>1. Connexion</h2>
            <div id="status" class="status disconnected">DÃ©connectÃ©</div>
            <div class="form-group">
                <input type="text" id="token" placeholder="Votre token JWT (depuis /auth/login)">
                <button onclick="connect()">Se connecter</button>
            </div>
        </div>
        
        <!-- Rejoindre un serveur -->
        <div class="section">
            <h2>2. Rejoindre un serveur</h2>
            <div class="form-group">
                <input type="number" id="serverId" placeholder="ID du serveur" value="1">
                <button onclick="joinServer()" id="joinBtn" disabled>Rejoindre</button>
            </div>
            <div>
                <strong>Utilisateurs connectÃ©s:</strong>
                <div class="users-list" id="usersList"></div>
            </div>
        </div>
        
        <!-- Messages -->
        <div class="section">
            <h2>3. Messages</h2>
            <div class="messages" id="messages"></div>
            <div class="typing" id="typing"></div>
            <div class="form-group">
                <input 
                    type="text" 
                    id="messageInput" 
                    placeholder="Tapez un message..." 
                    onkeyup="handleTyping()"
                    onkeypress="if(event.key==='Enter') sendMessage()"
                    disabled
                >
                <button onclick="sendMessage()" id="sendBtn" disabled>Envoyer</button>
            </div>
        </div>
        
        <!-- Logs -->
        <div class="section">
            <h2>ðŸ“Š Logs</h2>
            <div class="messages" id="logs"></div>
        </div>
    </div>
    
    <script>
        let socket = null;
        let currentServerId = null;
        let currentChannelId = 1; // Ã€ adapter
        let typingTimeout = null;
        let isTyping = false;
        
        function log(message, type = 'info') {
            const logs = document.getElementById('logs');
            const time = new Date().toLocaleTimeString();
            const colors = {
                info: '#6c5ce7',
                success: '#00b894',
                error: '#d63031'
            };
            logs.innerHTML += `<div style="color: ${colors[type]}">[${time}] ${message}</div>`;
            logs.scrollTop = logs.scrollHeight;
        }
        
        function connect() {
            const token = document.getElementById('token').value;
            if (!token) {
                alert('Veuillez entrer un token JWT');
                return;
            }
            
            log('Connexion au serveur WebSocket...');
            
            socket = io('http://localhost:3000', {
                transports: ['websocket', 'polling']
            });
            
            socket.on('connect', () => {
                log('âœ“ ConnectÃ© au serveur WebSocket', 'success');
                document.getElementById('status').className = 'status connected';
                document.getElementById('status').textContent = 'ConnectÃ©';
                
                // S'authentifier
                log('Envoi du token d\'authentification...');
                socket.emit('authenticate', { token });
            });
            
            socket.on('authenticated', (data) => {
                if (data.success) {
                    log(`âœ“ AuthentifiÃ© en tant que ${data.username}`, 'success');
                    document.getElementById('joinBtn').disabled = false;
                } else {
                    log(`âœ— Ã‰chec d\'authentification: ${data.error}`, 'error');
                }
            });
            
            socket.on('server:joined', (data) => {
                log(`âœ“ Rejoint le serveur ${data.server_id}`, 'success');
                currentServerId = data.server_id;
                updateUsersList(data.connected_users);
                document.getElementById('messageInput').disabled = false;
                document.getElementById('sendBtn').disabled = false;
            });
            
            socket.on('message:new', (data) => {
                addMessage(data.author_username, data.content, data.created_at);
            });
            
            socket.on('user:connected', (data) => {
                addSystemMessage(`${data.username} s'est connectÃ©`);
            });
            
            socket.on('user:disconnected', (data) => {
                addSystemMessage(`${data.username} s'est dÃ©connectÃ©`);
            });
            
            socket.on('user:typing', (data) => {
                showTyping(`${data.username} est en train d'Ã©crire...`);
            });
            
            socket.on('disconnect', () => {
                log('âœ— DÃ©connectÃ© du serveur', 'error');
                document.getElementById('status').className = 'status disconnected';
                document.getElementById('status').textContent = 'DÃ©connectÃ©';
            });
            
            socket.on('error', (data) => {
                log(`âœ— Erreur: ${data.error}`, 'error');
            });
        }
        
        function joinServer() {
            const serverId = parseInt(document.getElementById('serverId').value);
            if (socket && serverId) {
                log(`Tentative de rejoindre le serveur ${serverId}...`);
                socket.emit('join_server', { server_id: serverId });
            }
        }
        
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();
            
            if (!content) return;
            
            // Envoyer via l'API REST (pas WebSocket)
            const token = document.getElementById('token').value;
            fetch(`http://localhost:3000/channels/${currentChannelId}/messages`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ content })
            })
            .then(response => response.json())
            .then(data => {
                log('Message envoyÃ©', 'success');
                input.value = '';
            })
            .catch(error => {
                log(`Erreur lors de l'envoi: ${error}`, 'error');
            });
        }
        
        function handleTyping() {
            if (!socket || !currentServerId) return;
            
            if (!isTyping) {
                isTyping = true;
                socket.emit('typing_start', { channel_id: currentChannelId });
            }
            
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                isTyping = false;
                socket.emit('typing_stop', { channel_id: currentChannelId });
            }, 1000);
        }
        
        function addMessage(author, content, time) {
            const messages = document.getElementById('messages');
            const div = document.createElement('div');
            div.className = 'message';
            div.innerHTML = `
                <span class="author">${author}:</span>
                <span class="content">${content}</span>
                <span class="time">${new Date(time).toLocaleTimeString()}</span>
            `;
            messages.appendChild(div);
            messages.scrollTop = messages.scrollHeight;
        }
        
        function addSystemMessage(content) {
            const messages = document.getElementById('messages');
            const div = document.createElement('div');
            div.className = 'message system';
            div.textContent = content;
            messages.appendChild(div);
            messages.scrollTop = messages.scrollHeight;
        }
        
        function showTyping(text) {
            const typing = document.getElementById('typing');
            typing.textContent = text;
            setTimeout(() => {
                typing.textContent = '';
            }, 3000);
        }
        
        function updateUsersList(users) {
            const list = document.getElementById('usersList');
            list.innerHTML = users.map(id => `<div class="user-tag">User ${id}</div>`).join('');
        }
    </script>
</body>
</html>
